a very complex patch to backport
